<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>汎用一問一答トレーニング</title>
    <style>
        :root {
            --primary-color: #007aff; --primary-hover: #005ecb;
            --secondary-color: #6c757d; --secondary-hover: #5a6268;
            --success-color: #34c759; --success-bg: #eaf8ee;
            --danger-color: #ff3b30;  --danger-bg: #ffeeed;
            --warning-color: #ff9500;
            --star-color: #ffcc00;
            --light-bg: #f2f2f7; --text-color: #1c1c1e;
            --card-bg: #ffffff; --border-color: #e5e5ea;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
        }

        html { font-size: 15px; } 

        body {
            font-family: var(--font-family); margin: 0; padding: 15px; background-color: var(--light-bg);
            color: var(--text-color); text-align: center; display: flex; justify-content: center;
            align-items: center; min-height: calc(100vh - 30px); box-sizing: border-box;
        }

        .container {
            width: 100%; max-width: 800px; height: 70vh; max-height: 700px; 
            padding: 2rem 1.5rem; background-color: var(--card-bg); border-radius: 20px; 
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; overflow: hidden;
        }

        .screen { display: none; height: 100%; flex-direction: column; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .screen.active { display: flex; }
        .screen.visible { opacity: 1; }

        .centered-content { justify-content: center; text-align: center; }
        .centered-content h1 { font-size: 2.2rem; margin-top: 0; margin-bottom: 0.5rem; }
        /* ▼▼▼ pタグの最大幅を調整 ▼▼▼ */
        .centered-content p { font-size: 1.1rem; color: var(--secondary-color); max-width: 600px; margin: 0 auto 1.5rem; }
        #input-text { width: 100%; flex-grow: 1; padding: 1rem; margin: 1rem 0; border: 1px solid var(--border-color);
            border-radius: 12px; font-size: 1rem; resize: none; box-sizing: border-box; font-family: var(--font-family); }
        .importance-filter { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1.5rem; }
        .importance-filter label { font-size: 1rem; }
        .results-options { display: flex; flex-direction: column; gap: 1rem; margin-top: auto; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; }

        .results-summary { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .results-visual {
            width: 180px; height: 180px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: conic-gradient(var(--progress-color, var(--primary-color)) calc(var(--percentage) * 1%), var(--light-bg) 0);
            margin-bottom: 1.5rem; position: relative;
        }
        .results-visual::before { content: ''; position: absolute; width: 85%; height: 85%; background: var(--card-bg); border-radius: 50%; }
        #results-percentage { font-size: 3rem; font-weight: 700; z-index: 1; color: var(--progress-color, var(--primary-color)); }
        #results-details { font-size: 1.2rem; color: var(--secondary-color); }
        #end-screen .results-visual { --progress-color: var(--success-color); }
        
        #main-screen { justify-content: space-between; }
        #progress-area { flex-shrink: 0; }
        #content-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; overflow-y: auto; padding: 1rem 0; width: 100%; }
        #action-area { flex-shrink: 0; min-height: 90px; display: flex; flex-direction: column; justify-content: flex-end; padding-top: 1rem; }
        
        #progress-bar-container { width: 100%; height: 10px; background-color: var(--light-bg); border-radius: 5px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); border-radius: 5px; transition: width 0.4s ease; }
        .progress-info { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        #progress-text { font-size: 1.1rem; color: var(--secondary-color); }
        #importance-display { font-size: 1.3rem; color: var(--star-color); letter-spacing: 2px; }

        .large-text { font-size: 2.0rem; font-weight: 700; margin-bottom: 0.8rem; line-height: 1.3;
            word-wrap: break-word; display: flex; align-items: center; justify-content: center; gap: 1rem; width: 100%; }
        .small-text { font-size: 1.1rem; color: var(--secondary-color); margin-bottom: 1.5rem; width: 100%; word-wrap: break-word; line-height: 1.5; }
        .review-indicator { color: var(--danger-color); background-color: var(--danger-bg); font-size: 0.8rem; font-weight: bold; padding: 5px 10px; border-radius: 8px; vertical-align: middle; flex-shrink: 0; }
        .problem-view { width: 100%; }
        
        #select-options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.8rem; margin-top: 1.5rem; width: 100%;
        }
        #fill-content { text-align: center; line-height: 1.8; font-size: 1.15rem; margin-bottom: 1.5rem; width: 100%; }
        
        .input-form { max-width: 500px; width: 100%; margin: 0 auto; }
        .text-input { width: 100%; padding: 1rem; font-size: 1.1rem; border: 2px solid var(--border-color); border-radius: 12px; box-sizing: border-box; margin-bottom: 1rem; text-align: center; transition: border-color 0.2s; }
        .text-input:focus { border-color: var(--primary-color); outline: none; }
        .fill-input { padding: 4px 8px; font-size: 1.1rem; border: none; border-bottom: 2px solid var(--primary-color); width: 120px; text-align: center; margin: 0 5px; background: transparent; }
        
        #feedback-container { opacity: 0; transform: translateY(10px); transition: opacity 0.3s, transform 0.3s; margin-bottom: 1rem; padding: 1rem; border-radius: 12px; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        #feedback-container.visible { opacity: 1; transform: translateY(0); }
        #feedback-container.correct { color: var(--success-color); background-color: var(--success-bg); }
        #feedback-container.incorrect { color: var(--danger-color); background-color: var(--danger-bg); }
        #feedback-container::before { font-weight: bold; font-size: 1.3em; }
        #feedback-container.correct::before { content: '✓'; }
        #feedback-container.incorrect::before { content: '×'; }
        
        button { padding: 1rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; width: 100%; }
        button:hover { opacity: 0.9; } button:active { transform: scale(0.98); } button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-secondary:hover { background-color: var(--secondary-hover); }
        .btn-success { background-color: var(--success-color); color: white; }
        .select-option-btn { background-color: var(--card-bg); color: var(--primary-color); border: 2px solid var(--border-color); font-weight: 500; }
        .select-option-btn:hover { border-color: var(--primary-color); background-color: #f2f8ff; }
        .select-option-btn.correct { background-color: var(--success-bg) !important; color: var(--success-color); border-color: var(--success-color); }
        .select-option-btn.incorrect { background-color: var(--danger-bg) !important; color: var(--danger-color); border-color: var(--danger-color); }
        
        .button-container { display: none; justify-content: center; gap: 1rem; }
        .button-container.active { display: flex; }
        #action-btn { display: none; max-width: 500px; margin: 0 auto; }
        #action-btn.visible { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ▼▼▼ h1とpの内容を変更 ▼▼▼ -->
        <div id="setup-screen" class="screen active centered-content"><h1>汎用一問一答トレーニング</h1><p>学習したい内容を貼り付け、「開始」ボタンを押してください。</p><textarea id="input-text" placeholder="例: [check]apple@りんご_3#"></textarea><div class="importance-filter"><span>絞り込み:</span><label><input type="radio" name="importance" value="1-3" checked>すべて</label><label><input type="radio" name="importance" value="2-3">重要</label><label><input type="radio" name="importance" value="3-3">最重要</label></div><button id="start-btn" class="btn-primary">開始</button></div>
        <div id="main-screen" class="screen"><div id="progress-area"><div id="progress-bar-container"><div id="progress-bar"></div></div><div class="progress-info"><div id="progress-text"></div><div id="importance-display"></div></div></div><div id="content-area"><div id="check-view" class="problem-view"><div class="large-text"></div><div class="small-text"></div></div><div id="select-view" class="problem-view"><div class="large-text"></div><div class="small-text"></div><div id="select-options-container"></div></div><div id="enter-view" class="problem-view"><div class="large-text"></div><div class="input-form"><input type="text" id="enter-input" class="text-input" placeholder="答えを入力"></div></div><div id="fill-view" class="problem-view"><div class="large-text"></div><div id="fill-content"></div><div class="input-form"></div></div></div><div id="action-area"><div id="feedback-container"></div><div id="check-button-container" class="button-container input-form"><button id="review-btn" class="btn-secondary">後でもう一度確認</button><button id="ok-btn" class="btn-success">OK</button></div><button id="action-btn" class="btn-primary"></button></div></div>
        <div id="intermediate-screen" class="screen centered-content"><h1>お疲れ様でした！</h1><div class="results-summary"><div class="results-visual"><span id="results-percentage"></span></div><div id="results-details"></div></div><div class="results-options"><button id="retry-incorrect-btn" class="btn-primary">間違えた問題を復習</button><button id="retry-all-btn" class="btn-secondary">もう一度すべて解く</button><button id="restart-completely-btn" class="btn-secondary">新しい問題で始める</button></div></div>
        <div id="end-screen" class="screen centered-content"><h1>パーフェクト！</h1><div class="results-summary"><div class="results-visual"><span id="end-percentage">100%</span></div><p>すべての問題をマスターしました！</p></div><div class="results-options"><button id="restart-btn" class="btn-primary">新しい問題で始める</button></div></div>
    </div>
    <script>
        let originalWordList = [], wordList = [], reviewList = [];
        let currentIndex = 0, correctCount = 0, currentPassTotal = 0, isReviewPhase = false, currentScreen = 'setup';
        const screens = { setup: document.getElementById('setup-screen'), main: document.getElementById('main-screen'), intermediate: document.getElementById('intermediate-screen'), end: document.getElementById('end-screen') };
        const views = { check: document.getElementById('check-view'), select: document.getElementById('select-view'), enter: document.getElementById('enter-view'), fill: document.getElementById('fill-view') };
        const feedbackContainer = document.getElementById('feedback-container'), actionBtn = document.getElementById('action-btn'),
              checkButtonContainer = document.getElementById('check-button-container'), progressBar = document.getElementById('progress-bar'),
              progressText = document.getElementById('progress-text'), importanceDisplay = document.getElementById('importance-display');
        
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('retry-incorrect-btn').addEventListener('click', retryIncorrect);
        document.getElementById('retry-all-btn').addEventListener('click', retryAll);
        document.getElementById('restart-completely-btn').addEventListener('click', restartGame);
        document.getElementById('restart-btn').addEventListener('click', restartGame);
        
        function switchScreen(screenName) { screens[currentScreen].classList.remove('visible'); setTimeout(() => { screens[currentScreen].classList.remove('active'); currentScreen = screenName; screens[currentScreen].classList.add('active'); setTimeout(() => screens[currentScreen].classList.add('visible'), 50); }, 300); }
        screens['setup'].classList.add('visible');
        function startGame() {
            const allProblems = parseText(document.getElementById('input-text').value);
            const selectedImportance = document.querySelector('input[name="importance"]:checked').value;
            const [minImp, maxImp] = selectedImportance.split('-').map(Number);
            const filteredProblems = allProblems.filter(p => p.importance >= minImp && p.importance <= maxImp);
            if (filteredProblems.length === 0) { alert('選択した重要度の問題がありません。'); return; }
            originalWordList = JSON.parse(JSON.stringify(filteredProblems));
            startNewPass(filteredProblems, false);
        }
        function startNewPass(problems, isReview) {
            wordList = [...problems]; reviewList = []; currentIndex = 0; correctCount = 0; currentPassTotal = wordList.length; isReviewPhase = isReview;
            switchScreen('main'); showNextProblem();
        }
        function retryIncorrect() { if (reviewList.length > 0) startNewPass(reviewList, true); }
        function retryAll() { startNewPass(originalWordList, false); }
        function restartGame() { switchScreen('setup'); }
        function parseImportance(text) { const match = text.match(/_([1-3])$/); return match ? { text: text.substring(0, text.length - 2).trim(), importance: parseInt(match[1], 10) } : { text: text.trim(), importance: 1 }; }
        function parseText(text) { return text.trim().split('#').map(p => p.trim()).filter(Boolean).map(parseProblem).filter(Boolean); }
        function parseProblem(pStr) {
            let m;
            if (m = pStr.match(/^\[check\](.*?)\@(.*)$/s)) { const {text, importance} = parseImportance(m[2]); return {type:'check', largeText:m[1].trim(), smallText:text, importance}; }
            if (m = pStr.match(/^\[enter\](.*?)\@(.*)$/s)) { const {text, importance} = parseImportance(m[2]); return {type:'enter', largeText:m[1].trim(), correctAnswer:text, importance}; }
            if (m = pStr.match(/^\[fill\](.*?)\@(.*)$/s)) { const {text, importance} = parseImportance(m[2]); const answers = []; const parts = []; let lastIndex = 0; for (const fm of text.matchAll(/<([^>]+)>/g)) { parts.push(text.substring(lastIndex, fm.index)); answers.push(fm[1].trim()); lastIndex = fm.index + fm[0].length; } parts.push(text.substring(lastIndex)); return {type:'fill', largeText:m[1].trim(), questionParts:parts, answers, importance}; }
            if (m = pStr.match(/^\[select\](.*?)\@(.*?)((?:<[^>]+>|{[^}]+})+)$/s)) { const [,largeText, smallTextRaw, optionsStr] = m; const {text, importance} = parseImportance(smallTextRaw); const options = []; let correctAnswer = ''; [...optionsStr.matchAll(/<([^>]+)>|{([^}]+)}/g)].forEach(o => { (o[1]) ? options.push(o[1].trim()) : (correctAnswer=o[2].trim(), options.push(correctAnswer)); }); return {type:'select', largeText:largeText.trim(), smallText:text, options, correctAnswer, importance}; }
            return null;
        }
        function showNextProblem() {
            if (currentIndex >= wordList.length) { if (reviewList.length === 0) { switchScreen('end'); } else { showIntermediateResults(); } return; }
            updateProgress();
            feedbackContainer.classList.remove('visible', 'correct', 'incorrect'); actionBtn.classList.remove('visible'); checkButtonContainer.classList.remove('active');
            Object.values(views).forEach(v => v.style.display = 'none');
            const problem = wordList[currentIndex];
            const reviewMark = isReviewPhase ? `<span class="review-indicator">復習</span>` : '';
            const view = views[problem.type];
            const largeTextContent = view.querySelector('.large-text'); largeTextContent.innerHTML = '';
            const textSpan = document.createElement('span'); textSpan.textContent = problem.largeText;
            largeTextContent.appendChild(textSpan);
            if (isReviewPhase) largeTextContent.insertAdjacentHTML('beforeend', reviewMark);
            if (view.querySelector('.small-text')) view.querySelector('.small-text').textContent = problem.smallText || '';
            view.style.display = 'block';
            if (problem.type === 'check') setupCheck();
            else if (problem.type === 'select') setupSelect(problem);
            else if (problem.type === 'enter') setupEnter(problem);
            else if (problem.type === 'fill') setupFill(problem);
        }
        function setupCheck() {
            checkButtonContainer.classList.add('active');
            document.getElementById('ok-btn').onclick = () => handleAnswerFeedback(true);
            document.getElementById('review-btn').onclick = () => handleAnswerFeedback(false);
        }
        function setupSelect(problem) {
            const container = document.getElementById('select-options-container'); container.innerHTML = '';
            [...problem.options].sort(() => Math.random() - 0.5).forEach(optionText => {
                const btn = document.createElement('button'); btn.textContent = optionText; btn.className = 'select-option-btn';
                btn.onclick = (e) => { const isCorrect = (optionText === problem.correctAnswer); container.querySelectorAll('button').forEach(b => { b.disabled = true; if (b.textContent === problem.correctAnswer) b.classList.add('correct'); }); if (!isCorrect) e.target.classList.add('incorrect'); handleAnswerFeedback(isCorrect, problem.correctAnswer); }; container.appendChild(btn);
            });
        }
        function setupEnter(problem) {
            const input = document.getElementById('enter-input'); input.value = ''; input.disabled = false; 
            const handleSubmit = () => { input.disabled = true; handleAnswerFeedback(input.value.trim().toLowerCase() === problem.correctAnswer.trim().toLowerCase(), problem.correctAnswer); };
            actionBtn.textContent = '回答'; actionBtn.onclick = handleSubmit; actionBtn.classList.add('visible');
            input.onkeydown = (e) => { if (e.key === 'Enter') handleSubmit(); };
        }
        function setupFill(problem) {
            const contentDiv = document.getElementById('fill-content'); contentDiv.innerHTML = '';
            problem.questionParts.forEach((part, index) => { contentDiv.appendChild(document.createTextNode(part)); if (index < problem.answers.length) contentDiv.appendChild(document.createElement('input')).className = 'fill-input'; });
            const handleSubmit = () => { const inputs = [...contentDiv.querySelectorAll('.fill-input')]; const userAnswers = inputs.map(i => i.value.trim().toLowerCase()); const correctAnswers = problem.answers.map(a => a.trim().toLowerCase()); inputs.forEach(i => i.disabled = true); handleAnswerFeedback(userAnswers.length === correctAnswers.length && userAnswers.every((val, i) => val === correctAnswers[i]), problem.answers.join(', ')); };
            actionBtn.textContent = '回答'; actionBtn.onclick = handleSubmit; actionBtn.classList.add('visible');
        }
        function handleAnswerFeedback(isCorrect, correctAnswerText) {
            if (isCorrect) correctCount++; else reviewList.push(wordList[currentIndex]);
            if (wordList[currentIndex].type !== 'check') {
                if (isCorrect) { feedbackContainer.textContent = '正解！'; feedbackContainer.classList.add('correct'); }
                else { feedbackContainer.textContent = `不正解　正しい解答: ${correctAnswerText}`; feedbackContainer.classList.add('incorrect'); }
                feedbackContainer.classList.add('visible');
                actionBtn.textContent = '次へ'; actionBtn.onclick = moveToNextProblem; actionBtn.classList.add('visible');
            } else { moveToNextProblem(); }
        }
        function showIntermediateResults() {
            switchScreen('intermediate');
            const percentage = currentPassTotal > 0 ? (correctCount / currentPassTotal * 100) : 0;
            const visualEl = screens.intermediate.querySelector('.results-visual');
            document.getElementById('results-percentage').textContent = `${percentage.toFixed(0)}%`;
            document.getElementById('results-details').textContent = `${correctCount} / ${currentPassTotal} 問 正解`;
            visualEl.style.setProperty('--percentage', percentage);
            let color = 'var(--danger-color)';
            if (percentage >= 80) color = 'var(--success-color)';
            else if (percentage >= 50) color = 'var(--warning-color)';
            visualEl.style.setProperty('--progress-color', color);
            document.getElementById('results-percentage').style.color = color;
            document.getElementById('retry-incorrect-btn').disabled = (reviewList.length === 0);
        }
        function moveToNextProblem() { currentIndex++; showNextProblem(); }
        function updateProgress() {
            const percentage = currentPassTotal > 0 ? ((currentIndex) / currentPassTotal) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `問題 ${currentIndex + 1} / ${currentPassTotal}`;
            const problem = wordList[currentIndex];
            importanceDisplay.textContent = '★'.repeat(problem.importance) + '☆'.repeat(3 - problem.importance);
        }
    </script>
</body>
</html>
