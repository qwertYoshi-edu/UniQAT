<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>汎用一問一答トレーニング</title>
    
    <link rel="icon" href="./icons/icon-v4-192.png" type="image/png">
    <link rel="apple-touch-icon" href="./icons/icon-v4-512.png">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffffff">
    
    <style>
        :root {
            --primary-color: #34D399;
            --primary-hover: #10B981;
            --secondary-color: #6B7280;
            --secondary-hover: #4B5563;
            
            --success-color: #34D399;
            --success-bg: #ECFDF5;
            --success-text-on-bg: #065F46;

            --danger-color: #EF4444;
            --danger-bg: #FEF2F2;
            --danger-text-on-bg: #B91C1C;
            
            --warning-color: #FBBF24;
            --star-color: #FBBF24;

            --background-color: #ffffff;
            --light-bg: #F3F4F6;
            --text-color: #1F2937;
            
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            --accent-color: var(--primary-color);
            
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        html { font-size: 13px; }

        body {
            font-family: var(--font-family); margin: 0; padding: 16px; background-color: var(--background-color);
            color: var(--text-color); text-align: center; display: flex; justify-content: center;
            align-items: center; min-height: calc(100vh - 32px); box-sizing: border-box;
        }

        .container {
            width: 100%; max-width: 1000px;
            display: flex; flex-direction: column;
            position: relative;
        }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }

        .screen { display: none; width: 100%; flex-direction: column; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .screen.active { display: flex; }
        .screen.visible { opacity: 1; }

        .centered-content { justify-content: center; align-items: center; text-align: center; }
        
        #setup-screen .setup-content {
            width: 80%;
            margin: 0 auto;
            max-width: 800px;
        }
        #setup-screen h1 { 
            font-size: 3.5rem;
            color: var(--text-color); 
            letter-spacing: 1px; 
        }
        #setup-screen p { font-size: 1.2rem; color: var(--secondary-color); max-width: 660px; margin: 0 auto 1.8rem; }
        .description-wrapper { display: flex; align-items: center; justify-content: center; gap: 0.8rem; }
        #input-text { width: 100%; height: 25vh; min-height: 120px; padding: 1.1rem; margin: 1.1rem 0; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); font-size: 1.1rem; resize: vertical; box-sizing: border-box; font-family: var(--font-family); }
        
        .settings-wrapper {
            background-color: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            align-items: center;
        }
        .setting-item { text-align: left; }
        .setting-item > label:not(.setting-item-row) { font-weight: 600; margin-bottom: 0.8rem; display: block; }

        .start-buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 22px;
        }
        .start-buttons-container button { padding-top: 1.2rem; padding-bottom: 1.2rem; }

        /* Custom Form Controls */
        .setting-item-row.shuffle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0.5rem 0;
        }
        .shuffle-label { font-size: 1.1rem; font-weight: normal; user-select: none; }
        #shuffle-checkbox { opacity: 0; width: 0; height: 0; position: absolute; }
        .custom-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 6px;
            transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; background-color: var(--card-bg);
        }
        .custom-checkbox::after {
            content: ''; width: 10px; height: 10px;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: center; background-size: contain; opacity: 0; transition: opacity 0.2s ease;
        }
        #shuffle-checkbox:checked ~ .custom-checkbox { background-color: var(--primary-color); border-color: var(--primary-color); }
        #shuffle-checkbox:checked ~ .custom-checkbox::after { opacity: 1; }

        .importance-filter { display: inline-flex; border: 1px solid var(--border-color); border-radius: var(--radius-sm); overflow: hidden; background-color: var(--card-bg); }
        .importance-filter input[type="radio"] { display: none; }
        .importance-filter label { padding: 0.6rem 1.2rem; cursor: pointer; transition: all 0.2s ease; font-size: 1rem; font-weight: 500; color: var(--secondary-color); border-left: 1px solid var(--border-color); }
        .importance-filter label:first-of-type { border-left: none; }
        .importance-filter input[type="radio"]:checked + label { background-color: var(--primary-color); color: white; }

        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; border: 2px solid white; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; border: 2px solid white; }

        #intermediate-screen { position: relative; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: minmax(0, 1fr); gap: 2.2rem; height: 100%; width: 100%;}
        .incorrect-list-container { height: 100%; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); padding-right: 2.2rem; min-height: 0; }
        .incorrect-list-container h3 { margin: 0 0 1.1rem 0; text-align: left; flex-shrink: 0; font-size: 1.5rem; }
        #incorrect-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; text-align: left; flex-grow: 1; }
        #incorrect-list li { display: flex; justify-content: space-between; align-items: flex-start; gap: 1.1rem; padding: 0.9rem 0; border-bottom: 1px solid var(--light-bg); font-size: 1rem; }
        #incorrect-list li:last-child { border-bottom: none; }
        .incorrect-item-content { display: flex; gap: 0.9rem; align-items: flex-start; min-width: 0; }
        .incorrect-item-importance { color: var(--star-color); font-size: 1rem; flex-shrink: 0; letter-spacing: 1px; }
        .incorrect-item-text { word-break: break-all; }
        .incorrect-item-answer { color: var(--primary-color); font-weight: 600; text-align: right; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 132px; }

        .results-summary-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .results-summary-container h1 { font-size: 2.2rem; }
        .results-visual { width: 165px; height: 165px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: conic-gradient(var(--progress-color, var(--primary-color)) calc(var(--percentage) * 1%), var(--light-bg) 0); margin-bottom: 1.8rem; position: relative; }
        .results-visual::before { content: ''; position: absolute; width: 85%; height: 85%; background: var(--card-bg); border-radius: 50%; }
        #results-percentage { font-size: 2.8rem; font-weight: 700; z-index: 1; color: var(--progress-color, var(--primary-color)); }
        #results-details { font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 2.2rem; }
        .results-options { display: flex; flex-direction: column; gap: 1.1rem; width: 100%; max-width: 330px; margin: auto 0 0; }

        #end-screen { gap: 1.3rem; }
        #end-screen h1 { font-weight: 700; font-size: 2.8rem; margin: 0; transform: scale(1.4); opacity: 0; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        #end-screen.is-animating h1 { transform: scale(1); opacity: 1; }
        #end-screen .results-summary { flex-grow: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #end-screen .results-visual { width: 154px; height: 154px; margin-bottom: 0.8rem; --progress-color: var(--success-color); }
        #end-screen #end-percentage { font-weight: 700; font-size: 33px; color: var(--success-color); z-index: 1; }
        #end-screen .results-options { margin: 0 auto; max-width: 330px; width: 100%; }

        #main-screen { justify-content: space-between; height: calc(100vh - 32px); }
        #progress-area { flex-shrink: 0; padding-bottom: 1rem; }
        #content-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; overflow-y: auto; padding: 1.1rem 0; width: 100%; }
        #action-area { flex-shrink: 0; min-height: 100px; display: flex; flex-direction: column; justify-content: flex-end; padding-top: 1.1rem; }

        #progress-bar-container { width: 100%; height: 12px; background-color: var(--light-bg); border-radius: 6px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); border-radius: 6px; transition: width 0.4s ease; }
        .progress-info { display: flex; justify-content: space-between; align-items: center; margin-top: 13px; }
        .progress-info-left { display: flex; align-items: center; gap: 1.1rem; }
        #progress-text { font-size: 1.2rem; color: var(--secondary-color); }
        #mistake-counter { font-size: 1.2rem; color: var(--danger-color); font-weight: 600; visibility: hidden; }
        #mistake-counter.visible { visibility: visible; }
        #importance-display { font-size: 1.4rem; color: var(--star-color); letter-spacing: 2px; }
        #mode-indicator { text-align: center; color: var(--secondary-color); font-size: 0.9rem; margin-top: 8px; height: 1.2rem; }

        .large-text { font-size: 2.2rem; font-weight: 700; margin-bottom: 0.9rem; line-height: 1.3; word-wrap: break-word; display: flex; align-items: center; justify-content: center; gap: 1.1rem; width: 100%; }
        .small-text { font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 1.8rem; width: 100%; word-wrap: break-word; line-height: 1.5; }
        .review-indicator { color: var(--danger-text-on-bg); background-color: var(--danger-bg); font-size: 0.9rem; font-weight: bold; padding: 6px 11px; border-radius: var(--radius-sm); vertical-align: middle; flex-shrink: 0; }
        .problem-view { width: 100%; transition: opacity 300ms ease-out, transform 300ms ease-out; }
        .problem-view.is-entering { opacity: 0; transform: translateY(22px); }

        .final-check-answer { font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding: 2px 4px; }
        #select-options-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.9rem; margin-top: 1.8rem; width: 100%; }
        #fill-content { text-align: center; line-height: 1.8; font-size: 1.25rem; margin-bottom: 1.8rem; width: 100%; }
        .fill-prefilled { font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding: 5px 9px; margin: 0 6px; }

        .input-form { max-width: 550px; width: 100%; margin: 0 auto; }
        .text-input { width: 100%; padding: 1.1rem; font-size: 1.2rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); box-sizing: border-box; margin-bottom: 1.1rem; text-align: center; transition: border-color 0.2s; }
        .text-input:focus { border-color: var(--primary-color); outline: none; }
        .fill-input { padding: 5px 9px; font-size: 1.2rem; border: none; border-bottom: 2px solid var(--primary-color); width: 132px; text-align: center; margin: 0 6px; background: transparent; transition: all 0.2s; border-radius: 4px 4px 0 0;}
        .fill-input.correct, .fill-input.correct:disabled { border-bottom-color: var(--success-color); background-color: var(--success-bg); color: var(--success-text-on-bg); opacity: 1; }
        .fill-input.incorrect, .fill-input.incorrect:disabled { border-bottom-color: var(--danger-color); background-color: var(--danger-bg); color: var(--danger-text-on-bg); opacity: 1; }

        #feedback-container { opacity: 0; transform: translateY(11px); transition: opacity 0.3s, transform 0.3s; margin-bottom: 1.1rem; padding: 1.1rem; border-radius: var(--radius-md); font-weight: 600; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; gap: 0.8rem; position: relative; }
        #feedback-container.visible { opacity: 1; transform: translateY(0); }
        #feedback-container.correct { color: var(--success-text-on-bg); background-color: var(--success-bg); border: 1px solid var(--success-color); }
        #feedback-container.incorrect { color: var(--danger-text-on-bg); background-color: var(--danger-bg); border: 1px solid var(--danger-color); }
        #feedback-text::before { font-weight: bold; font-size: 1.4em; margin-right: 0.8rem; }
        #feedback-container.correct #feedback-text::before { content: '✓'; }
        #feedback-container.incorrect #feedback-text::before { content: '×'; }
        #add-to-review-btn { font-size: 0.9rem; padding: 5px 11px; width: auto; position: absolute; right: 1.1rem; top: 50%; transform: translateY(-50%); background-color: var(--secondary-color); color: white; border-radius: 6px; }
        #add-to-review-btn:disabled { background-color: var(--border-color); color: var(--secondary-color); }

        button { 
            padding: 1.0rem; font-size: 1.1rem; font-weight: 600; border: none; border-radius: var(--radius-md); 
            cursor: pointer; transition: background-color 0.2s, transform 0.1s; width: 100%; 
        }
        button:hover { opacity: 0.9; } button:active { transform: scale(0.98); } button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--card-bg); color: var(--secondary-color); border: 1px solid var(--border-color); } .btn-secondary:hover { background-color: var(--light-bg); border-color: #D1D5DB; }
        .btn-success { background-color: var(--success-color); color: white; }
        
        .btn-with-icon { display: inline-flex; align-items: center; justify-content: center; gap: 0.6em; }
        .btn-with-icon svg { width: 1.3em; height: 1.3em; fill: currentColor; }

        .select-option-btn { background-color: var(--card-bg); color: var(--primary-color); border: 2px solid var(--border-color); font-weight: 500; }
        .select-option-btn:hover { border-color: var(--primary-color); background-color: var(--success-bg); }
        .select-option-btn.correct { background-color: var(--success-bg) !important; color: var(--success-text-on-bg); border-color: var(--success-color); }
        .select-option-btn.incorrect { background-color: var(--danger-bg) !important; color: var(--danger-text-on-bg); border-color: var(--danger-color); }

        .button-container { display: none; justify-content: center; gap: 1.1rem; }
        .button-container.active { display: flex; }
        #action-btn { display: none; max-width: 550px; margin: 0 auto; }
        #action-btn.visible { display: block; }

        #help-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border-color); background: var(--card-bg); color: var(--secondary-color); font-size: 1.2rem; font-weight: bold; line-height: 1; padding: 0; flex-shrink: 0; cursor: pointer; transition: all 0.2s; }
        #help-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
        
        /* ===== モーダル ===== */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; background: rgba(0,0,0,0.6); }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-overlay { position: absolute; width: 100%; height: 100%; }
        .modal-content { position: relative; background: var(--card-bg); padding: 2.2rem; border-radius: var(--radius-lg); max-width: 660px; width: 90%; max-height: 80vh; overflow-y: auto; text-align: left; transform: scale(0.95); transition: transform 0.3s; }
        .modal.active .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; font-size: 1.5rem; }
        .modal-close-btn { position: absolute; top: 0.8rem; right: 0.8rem; width: 48px; height: 48px; border: none; background: transparent; font-size: 1.8rem; cursor: pointer; color: var(--secondary-color); line-height: 1; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s; }
        .modal-close-btn:hover { background-color: var(--light-bg); color: var(--text-color); }

        /* ===== ヘルプモーダル専用スタイル ===== */
        .help-section { margin-bottom: 2rem; }
        .help-section h3 {
            display: flex;
            align-items: center;
            gap: 0.5em;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .help-section h3 svg { width: 1.2em; height: 1.2em; color: var(--primary-color); }
        .help-section p { margin: 0 0 1rem 0; color: var(--secondary-color); }
        .help-section code { background-color: var(--light-bg); padding: 2px 6px; border-radius: 4px; font-size: 0.95em; color: var(--text-color); font-weight: 600; }
        
        .help-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 0.95rem; }
        .help-table th, .help-table td { padding: 0.8rem; border: 1px solid var(--border-color); text-align: left; }
        .help-table th { background-color: var(--light-bg); font-weight: 600; }
        .help-table td:first-child { font-weight: 600; text-align: center; }
        .help-table code { font-family: monospace; }
        
        .copy-example { background-color: var(--light-bg); border: 1px solid var(--border-color); padding: 1rem; border-radius: var(--radius-sm); font-family: monospace; font-size: 1rem; line-height: 1.6; white-space: pre-wrap; word-break: break-all; }
        #copy-textarea { width: 100%; height: 250px; resize: vertical; box-sizing: border-box; margin-top: 1rem; background-color: var(--light-bg); border: 1px solid var(--border-color); padding: 1rem; border-radius: var(--radius-sm); font-family: monospace; font-size: 1rem;}

        .list-toggle-btn, .list-overlay { display: none; }

        @media (min-width: 769px) {
            body { padding: 80px 32px; min-height: calc(100vh - 160px); }
            #main-screen { height: calc(100vh - 160px); }
            #setup-screen .setup-content { width: 90%; max-width: 900px; }
            .results-grid { grid-template-columns: 1.2fr 1fr; }
        }

        @media (max-width: 768px) {
            #setup-screen .setup-content { width: 100%; }
            #setup-screen h1 { font-size: 2.8rem; }
            .settings-wrapper { padding: 1.5rem; }
            .settings-row { grid-template-columns: 1fr; gap: 1.8rem; }
            .setting-item { text-align: left; }
            .setting-item > label:not(.setting-item-row) { margin-bottom: 1rem; }
            .setting-item.importance-setting > label { margin-bottom: 1rem; }
            .importance-setting .importance-filter { padding-left: 0.5rem; }
            #feedback-container { flex-direction: column; gap: 0.8rem; }
            #add-to-review-btn { position: relative; transform: none; top: auto; right: auto; width: auto; padding: 6px 12px; font-size: 1rem; }
            #post-answer-buttons.active { flex-direction: column; }
            #intermediate-screen { overflow-x: hidden; }
            .results-grid { grid-template-columns: 1fr; }
            .incorrect-list-container {
                position: fixed; left: 0; top: 0; width: 80vw; height: 100%; background-color: var(--card-bg); z-index: 1002;
                transform: translateX(-100%); transition: transform 0.3s ease-in-out; padding: 1.5rem;
                box-sizing: border-box; border-right: none;
            }
            #intermediate-screen.list-open .incorrect-list-container { transform: translateX(0); }
            .list-toggle-btn {
                display: flex; align-items: center; justify-content: center; position: fixed; left: 10px; top: 50%;
                transform: translateY(-50%); z-index: 2001; width: 36px; height: 44px; border-radius: 0 50% 50% 0;
                border: 1px solid var(--border-color); border-left: none; background-color: var(--card-bg); font-size: 1.5rem;
                font-weight: bold; color: var(--primary-color); cursor: pointer; transition: left 0.3s ease-in-out;
                padding: 0; padding-left: 2px;
            }
            #intermediate-screen.list-open .list-toggle-btn { left: 80vw; }
            .list-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1001;
                opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
            }
            #intermediate-screen.list-open .list-overlay { display: block; opacity: 1; pointer-events: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="confetti-canvas"></canvas>
        <div id="setup-screen" class="screen active centered-content">
            <div class="setup-content">
                <h1>汎用一問一答トレーニング</h1>
                <div class="description-wrapper">
                    <p>学習したい内容を貼り付け、オプションを選択して開始してください。</p>
                    <button id="help-btn" aria-label="入力形式のヘルプ">?</button>
                </div>
                <textarea id="input-text" placeholder="ここに問題リストを貼り付けます。形式は「?」ボタンで確認できます。"></textarea>
                <div class="settings-wrapper">
                    <div class="settings-row">
                        <div class="setting-item">
                            <label for="shuffle-checkbox" class="setting-item-row shuffle-container">
                                <span class="shuffle-label">出題順をランダムに</span>
                                <input type="checkbox" id="shuffle-checkbox">
                                <div class="custom-checkbox"></div>
                            </label>
                        </div>
                        <div class="setting-item importance-setting">
                            <label>重要度で絞り込み</label>
                            <div class="importance-filter">
                                <input type="radio" name="importance" value="1-3" id="imp-all" checked><label for="imp-all">すべて</label>
                                <input type="radio" name="importance" value="2-3" id="imp-high"><label for="imp-high">重要</label>
                                <input type="radio" name="importance" value="3-3" id="imp-highest"><label for="imp-highest">最重要</label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label for="fill-rate-slider">穴埋め問題の空欄率: <span id="fill-rate-value">100</span>%</label>
                            <input type="range" id="fill-rate-slider" min="50" max="100" value="100">
                        </div>
                    </div>
                </div>
                <div class="start-buttons-container">
                    <button id="start-btn" class="btn-primary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><span>通常スタート</span></button>
                    <button id="final-check-btn" class="btn-secondary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>直前チェック</span></button>
                </div>
            </div>
        </div>

        <div id="main-screen" class="screen"><div id="progress-area"><div id="progress-bar-container"><div id="progress-bar"></div></div><div class="progress-info"><div class="progress-info-left"><div id="progress-text"></div><div id="mistake-counter"></div></div><div id="importance-display"></div></div><div id="mode-indicator"></div></div><div id="content-area"><div id="check-view" class="problem-view"><div class="large-text"></div><div class="small-text"></div></div><div id="select-view" class="problem-view"><div class="large-text"></div><div class="small-text"></div><div id="select-options-container"></div></div><div id="enter-view" class="problem-view"><div class="large-text"></div><div class="input-form"><input type="text" id="enter-input" class="text-input" placeholder="答えを入力"></div></div><div id="fill-view" class="problem-view"><div class="large-text"></div><div id="fill-content"></div><div class="input-form"></div></div></div><div id="action-area"><div id="feedback-container"><span id="feedback-text"></span><button id="add-to-review-btn">復習リストに追加</button></div><div id="check-button-container" class="button-container input-form"><button id="review-btn" class="btn-secondary">後でもう一度確認</button><button id="ok-btn" class="btn-success btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>OK</span></button></div><div id="post-answer-buttons" class="button-container input-form"><button id="retry-current-problem-btn" class="btn-secondary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg><span>この問題を解き直す</span></button><button id="next-problem-btn" class="btn-primary">次へ</button></div><button id="action-btn" class="btn-primary"></button></div></div>
        
        <div id="intermediate-screen" class="screen">
            <button id="toggle-incorrect-list-btn" class="list-toggle-btn">&gt;</button>
            <div class="list-overlay"></div>
            <div class="results-grid">
                <div class="incorrect-list-container"><h3>間違えた問題</h3><ul id="incorrect-list"></ul></div>
                <div class="results-summary-container">
                    <h1>お疲れ様でした！</h1>
                    <div class="results-summary"><div class="results-visual"><span id="results-percentage"></span></div><div id="results-details"></div></div>
                    <div class="results-options">
                        <button id="retry-incorrect-btn" class="btn-primary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg><span>間違えた問題を復習</span></button>
                        <button id="copy-incorrect-btn" class="btn-secondary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg><span>誤答問題をコピー</span></button>
                        <button id="retry-all-btn" class="btn-secondary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg><span>もう一度すべて解く</span></button>
                        <button id="retry-final-check-btn" class="btn-secondary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>直前チェック (全問題)</span></button>
                        <button id="restart-completely-btn" class="btn-secondary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg><span>新しい問題で始める</span></button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="end-screen" class="screen centered-content">
            <h1>パーフェクト！</h1>
            <div class="results-summary">
                <div class="results-visual">
                    <span id="end-percentage">0%</span>
                </div>
                <p>すべての問題をマスターしました！</p>
            </div>
            <div class="results-options">
                <button id="end-retry-all-btn" class="btn-primary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg><span>もう一度すべて解く</span></button>
                <button id="end-restart-btn" class="btn-secondary btn-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg><span>新しい問題で始める</span></button>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>問題の作り方ガイド</h2>
            
            <div class="help-section">
                <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>3つの基本ルール</h3>
                <ol style="padding-left: 20px; color: var(--secondary-color);">
                    <li><strong>基本の形:</strong> <code>[種類] 問題文 @ 答え</code> で書く</li>
                    <li><strong>区切り:</strong> 問題の終わりには <code>#</code> を付ける</li>
                    <li><strong>重要度:</strong> 最後に <code>_3</code> のように付ける (任意)</li>
                </ol>
            </div>
            
            <div class="help-section">
                <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>記号の役割</h3>
                <table class="help-table">
                    <thead><tr><th>記号</th><th>役割</th></tr></thead>
                    <tbody>
                        <tr><td><code>[]</code></td><td>問題の種類を指定（<code>check</code>, <code>select</code> など）</td></tr>
                        <tr><td><code>@</code></td><td>問題と答えの区切り</td></tr>
                        <tr><td><code>{}</code></td><td>選択問題の<strong>正解</strong></td></tr>
                        <tr><td><code>&lt;&gt;</code></td><td>選択問題の<strong>不正解</strong> / 穴埋めの<strong>空欄</strong></td></tr>
                        <tr><td><code>#</code></td><td>問題の終わり</td></tr>
                        <tr><td><code>_</code></td><td>重要度を指定（<code>_1</code> 低 〜 <code>_3</code> 高）</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="help-section">
                <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-1.125 0-2.062.938-2.062 2.063v7.5c0 1.125.937 2.063 2.063 2.063h9.75c1.125 0 2.063-.938 2.063-2.063v-7.5c0-1.125-.938-2.063-2.063-2.063H8.25z" /></svg>4つの問題タイプ 早見表</h3>
                <table class="help-table">
                    <thead><tr><th>種類</th><th>書き方の例</th><th>どんな時に使う？</th></tr></thead>
                    <tbody>
                        <tr><td><code>[check]</code></td><td><code>[check] apple @ りんご_3</code></td><td>暗記カードのように使いたい時</td></tr>
                        <tr><td><code>[select]</code></td><td><code>[select] 首都は？ @ {東京}&lt;大阪&gt;_3</code></td><td>選択肢から正解を選びたい時</td></tr>
                        <tr><td><code>[enter]</code></td><td><code>[enter] 1+1=? @ 2_1</code></td><td>答えを正確に書きたい時</td></tr>
                        <tr><td><code>[fill]</code></td><td><code>[fill] 犬も歩けば @ &lt;棒&gt;にあたる_2</code></td><td>文章の一部を答えさせたい時</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="help-section" style="margin-bottom: 0;">
                <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a2.25 2.25 0 01-2.25 2.25h-1.5a2.25 2.25 0 01-2.25-2.25v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>コピーして試そう</h3>
                <p>以下の例文をコピーして、すぐにお試しいただけます。</p>
                <div class="copy-example">[check]apple@りんご_3#
[select]日本の首都は？@{東京}&lt;大阪&gt;&lt;京都&gt;_3#
[enter]1+1=?@2_1#
[fill]犬も歩けば@&lt;棒&gt;にあたる_2#</div>
            </div>
        </div>
    </div>
    
    <div id="copy-modal" class="modal"><div class="modal-overlay"></div><div class="modal-content"><button class="modal-close-btn">&times;</button><h2>誤答問題リスト</h2><p>以下のテキストをコピーして、次回の学習に活用してください。</p><textarea id="copy-textarea" readonly></textarea></div></div>

    <script>
        let originalWordList = [], wordList = [], reviewList = [];
        let currentIndex = 0, correctCount = 0, checkOKCount = 0, checkReviewCount = 0;
        let currentPassTotalForRate = 0, isReviewPhase = false, currentScreen = 'setup';
        let mistakeCount = 0, fillBlankRate = 100, isCheckOnlyMode = false, isFinalCheckMode = false;

        const screens = { setup: document.getElementById('setup-screen'), main: document.getElementById('main-screen'), intermediate: document.getElementById('intermediate-screen'), end: document.getElementById('end-screen') };
        const views = { check: document.getElementById('check-view'), select: document.getElementById('select-view'), enter: document.getElementById('enter-view'), fill: document.getElementById('fill-view') };
        const feedbackContainer = document.getElementById('feedback-container'), feedbackText = document.getElementById('feedback-text'), actionBtn = document.getElementById('action-btn'),
              checkButtonContainer = document.getElementById('check-button-container'), progressBar = document.getElementById('progress-bar'),
              progressTextEl = document.getElementById('progress-text'), importanceDisplay = document.getElementById('importance-display'),
              mistakeCounter = document.getElementById('mistake-counter'), addToReviewBtn = document.getElementById('add-to-review-btn'),
              modeIndicator = document.getElementById('mode-indicator');
        const helpBtn = document.getElementById('help-btn'), helpModal = document.getElementById('help-modal');
        const copyIncorrectBtn = document.getElementById('copy-incorrect-btn'), copyModal = document.getElementById('copy-modal'), copyTextarea = document.getElementById('copy-textarea');
        const fillRateSlider = document.getElementById('fill-rate-slider'), fillRateValue = document.getElementById('fill-rate-value');
        const confettiCanvas = document.getElementById('confetti-canvas');
        
        const postAnswerButtons = document.getElementById('post-answer-buttons');
        const nextProblemBtn = document.getElementById('next-problem-btn');
        const retryCurrentProblemBtn = document.getElementById('retry-current-problem-btn');
        
        const intermediateScreen = document.getElementById('intermediate-screen');
        const toggleIncorrectListBtn = document.getElementById('toggle-incorrect-list-btn');
        const listOverlay = document.querySelector('.list-overlay');

        if (toggleIncorrectListBtn) {
            toggleIncorrectListBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                intermediateScreen.classList.toggle('list-open');
                toggleIncorrectListBtn.innerHTML = intermediateScreen.classList.contains('list-open') ? '&lt;' : '&gt;';
            });
        }
        if (listOverlay) {
            listOverlay.addEventListener('click', (e) => {
                e.stopPropagation();
                intermediateScreen.classList.remove('list-open');
                toggleIncorrectListBtn.innerHTML = '&gt;';
            });
        }

        function setupModal(modal) {
            const overlay = modal.querySelector('.modal-overlay');
            const closeBtn = modal.querySelector('.modal-close-btn');
            overlay.addEventListener('click', () => modal.classList.remove('active'));
            closeBtn.addEventListener('click', () => modal.classList.remove('active'));
        }
        
        helpBtn.addEventListener('click', () => helpModal.classList.add('active'));
        setupModal(helpModal);
        copyIncorrectBtn.addEventListener('click', () => {
            const incorrectProblemsText = reviewList.map(reconstructProblemString).join('#\n');
            copyTextarea.value = incorrectProblemsText;
            copyModal.classList.add('active');
        });
        setupModal(copyModal);
        copyTextarea.addEventListener('click', function() { this.select(); });

        document.getElementById('start-btn').addEventListener('click', () => startGame(false));
        document.getElementById('final-check-btn').addEventListener('click', () => startGame(true));
        document.getElementById('retry-incorrect-btn').addEventListener('click', retryIncorrect);
        document.getElementById('retry-all-btn').addEventListener('click', retryAll);
        document.getElementById('retry-final-check-btn').addEventListener('click', () => { isFinalCheckMode = true; startNewPass(originalWordList, false); });
        document.getElementById('restart-completely-btn').addEventListener('click', restartGame);
        document.getElementById('end-retry-all-btn').addEventListener('click', retryAll);
        document.getElementById('end-restart-btn').addEventListener('click', restartGame);
        fillRateSlider.addEventListener('input', (e) => { fillRateValue.textContent = e.target.value; });

        function switchScreen(screenName) {
            screens[currentScreen].classList.remove('visible');
            setTimeout(() => {
                screens[currentScreen].classList.remove('active');
                currentScreen = screenName;
                screens[currentScreen].classList.add('active');

                if (screenName === 'intermediate') {
                    showIntermediateResults();
                } else if (screenName === 'end') {
                    triggerPerfectAnimation();
                }

                setTimeout(() => screens[currentScreen].classList.add('visible'), 50);
            }, 300);
        }
        screens['setup'].classList.add('visible');

        function startGame(isCheckMode = false) {
            isFinalCheckMode = isCheckMode;
            const allProblems = parseText(document.getElementById('input-text').value);
            const selectedImportance = document.querySelector('input[name="importance"]:checked').value;
            const [minImp, maxImp] = selectedImportance.split('-').map(Number);
            let filteredProblems = allProblems.filter(p => p.importance >= minImp && p.importance <= maxImp);
            if (document.getElementById('shuffle-checkbox').checked) {
                filteredProblems.sort(() => Math.random() - 0.5);
            }
            if (filteredProblems.length === 0) { alert('選択した重要度の問題がありません。'); return; }
            originalWordList = JSON.parse(JSON.stringify(filteredProblems));
            fillBlankRate = parseInt(fillRateSlider.value, 10);
            startNewPass(filteredProblems, false);
        }
        function startNewPass(problems, isReview) {
            wordList = [...problems]; reviewList = []; currentIndex = 0; correctCount = 0; checkOKCount = 0; checkReviewCount = 0;
            mistakeCount = 0;
            currentPassTotalForRate = wordList.filter(p => p.type !== 'check').length;
            isCheckOnlyMode = wordList.every(p => p.type === 'check');
            isReviewPhase = isReview;
            modeIndicator.textContent = isFinalCheckMode ? '直前チェック' : '通常モード';
            switchScreen('main'); showNextProblem();
        }
        function retryIncorrect() { isFinalCheckMode = false; if (reviewList.length > 0) startNewPass(reviewList, true); }
        function retryAll() { isFinalCheckMode = false; startNewPass(originalWordList, false); }
        function restartGame() { switchScreen('setup'); }
        function parseImportance(text) { const match = text.match(/_([1-3])$/); return match ? { text: text.substring(0, text.length - 2).trim(), importance: parseInt(match[1], 10) } : { text: text.trim(), importance: 1 }; }
        function parseText(text) { return text.trim().split('#').map(p => p.trim()).filter(Boolean).map(parseProblem).filter(Boolean); }
        function parseProblem(pStr) {
            const { text: coreStr, importance } = parseImportance(pStr);
            let m;
            if (m = coreStr.match(/^\[check\](.*?)\@(.*)$/s)) { return {type:'check', largeText:m[1].trim(), smallText:m[2].trim(), importance}; }
            if (m = coreStr.match(/^\[enter\](.*?)\@(.*)$/s)) { return {type:'enter', largeText:m[1].trim(), correctAnswer:m[2].trim(), importance}; }
            if (m = coreStr.match(/^\[fill\](.*?)\@(.*)$/s)) { const text = m[2]; const answers = []; const parts = []; let lastIndex = 0; for (const fm of text.matchAll(/<([^>]+)>/g)) { parts.push(text.substring(lastIndex, fm.index)); answers.push(fm[1].trim()); lastIndex = fm.index + fm[0].length; } parts.push(text.substring(lastIndex)); return {type:'fill', largeText:m[1].trim(), questionParts:parts, answers, importance}; }
            if (m = coreStr.match(/^\[select\](.*?)\@(.*?)((?:<[^>]+>|{[^}]+})+)$/s)) { const [,largeText, smallText, optionsStr] = m; const options = []; let correctAnswer = ''; [...optionsStr.matchAll(/<([^>]+)>|{([^}]+)}/g)].forEach(o => { (o[1]) ? options.push(o[1].trim()) : (correctAnswer=o[2].trim(), options.push(correctAnswer)); }); return {type:'select', largeText:largeText.trim(), smallText:smallText.trim(), options, correctAnswer, importance}; }
            return null;
        }
        
        function reconstructProblemString(p) {
            let coreStr = '';
            switch (p.type) {
                case 'check': coreStr = `[check]${p.largeText}@${p.smallText}`; break;
                case 'enter': coreStr = `[enter]${p.largeText}@${p.correctAnswer}`; break;
                case 'select':
                    const optionsStr = p.options.map(opt => (opt === p.correctAnswer ? `{${opt}}` : `<${opt}>`)).sort().join('');
                    coreStr = `[select]${p.largeText}@${p.smallText}${optionsStr}`;
                    break;
                case 'fill':
                    const answerPart = p.questionParts.map((part, i) => part + (i < p.answers.length ? `<${p.answers[i]}>` : '')).join('');
                    coreStr = `[fill]${p.largeText}@${answerPart}`;
                    break;
            }
            return `${coreStr}_${p.importance}`;
        }

        function normalizeAnswer(str) {
            if (typeof str !== 'string') return '';
            const trimmedStr = str.trim().replace(/\.\.\./g, '…');
            if (trimmedStr.includes('、')) {
                return trimmedStr.split('、').map(part => part.trim()).filter(part => part.length > 0).sort().join('、');
            }
            return trimmedStr;
        }

        function showNextProblem() {
            if (currentIndex >= wordList.length) {
                if (reviewList.length === 0) { switchScreen('end'); } else { switchScreen('intermediate'); }
                return;
            }
            updateProgress();
            feedbackContainer.classList.remove('visible', 'correct', 'incorrect');
            actionBtn.classList.remove('visible');
            checkButtonContainer.classList.remove('active');
            postAnswerButtons.classList.remove('active');
            addToReviewBtn.style.display = 'none';
            Object.values(views).forEach(v => v.style.display = 'none');

            const problem = wordList[currentIndex];
            const reviewMark = isReviewPhase ? `<span class="review-indicator">復習</span>` : '';
            const view = views[isFinalCheckMode ? 'check' : problem.type];
            const largeTextContent = view.querySelector('.large-text');
            largeTextContent.innerHTML = '';
            const textSpan = document.createElement('span'); textSpan.textContent = problem.largeText;
            largeTextContent.appendChild(textSpan);
            if (isReviewPhase) largeTextContent.insertAdjacentHTML('beforeend', reviewMark);
            
            view.classList.add('is-entering');
            view.style.display = 'block';
            requestAnimationFrame(() => { view.classList.remove('is-entering'); });

            if (isFinalCheckMode) {
                let answerHtml = '';
                switch(problem.type) {
                    case 'select': case 'enter': answerHtml = problem.correctAnswer; break;
                    case 'fill': answerHtml = problem.questionParts.map((part, index) => part + (index < problem.answers.length ? `<span class="final-check-answer">${problem.answers[index]}</span>` : '')).join(''); break;
                    default: answerHtml = problem.smallText || '';
                }
                view.querySelector('.small-text').innerHTML = answerHtml;
                setupCheck();
            } else {
                if (view.querySelector('.small-text')) view.querySelector('.small-text').textContent = problem.smallText || '';
                if (problem.type === 'check') setupCheck();
                else if (problem.type === 'select') setupSelect(problem);
                else if (problem.type === 'enter') setupEnter(problem);
                else if (problem.type === 'fill') setupFill(problem);
            }
        }

        function setupCheck() {
            checkButtonContainer.classList.add('active');
            document.getElementById('ok-btn').onclick = () => handleAnswerFeedback(true);
            document.getElementById('review-btn').onclick = () => handleAnswerFeedback(false);
        }
        function setupSelect(problem) {
            const container = document.getElementById('select-options-container'); container.innerHTML = '';
            [...problem.options].sort(() => Math.random() - 0.5).forEach(optionText => {
                const btn = document.createElement('button'); btn.textContent = optionText; btn.className = 'select-option-btn';
                btn.onclick = (e) => { const isCorrect = (optionText === problem.correctAnswer); container.querySelectorAll('button').forEach(b => { b.disabled = true; if (b.textContent === problem.correctAnswer) b.classList.add('correct'); }); if (!isCorrect) e.target.classList.add('incorrect'); handleAnswerFeedback(isCorrect, problem.correctAnswer); }; container.appendChild(btn);
            });
        }
        function setupEnter(problem) {
            const input = document.getElementById('enter-input'); input.value = ''; input.disabled = false;
            const handleSubmit = () => { input.disabled = true; const isCorrect = normalizeAnswer(input.value).toLowerCase() === normalizeAnswer(problem.correctAnswer).toLowerCase(); handleAnswerFeedback(isCorrect, problem.correctAnswer); };
            actionBtn.textContent = '回答'; actionBtn.onclick = handleSubmit; actionBtn.classList.add('visible');
            input.onkeydown = (e) => { if (e.key === 'Enter') handleSubmit(); };
        }
        function setupFill(problem) {
            const contentDiv = document.getElementById('fill-content'); contentDiv.innerHTML = '';
            const totalBlanks = problem.answers.length;
            const blanksToShow = Math.round(totalBlanks * (fillBlankRate / 100));
            const blankIndices = new Set([...Array(totalBlanks).keys()].sort(() => 0.5 - Math.random()).slice(0, blanksToShow));

            problem.questionParts.forEach((part, index) => {
                contentDiv.appendChild(document.createTextNode(part));
                if (index < totalBlanks) {
                    if (blankIndices.has(index)) {
                        const input = document.createElement('input'); input.className = 'fill-input'; input.dataset.answerIndex = index; contentDiv.appendChild(input);
                    } else {
                        const prefilled = document.createElement('span'); prefilled.className = 'fill-prefilled'; prefilled.textContent = problem.answers[index]; contentDiv.appendChild(prefilled);
                    }
                }
            });
            const handleSubmit = () => {
                const inputs = [...contentDiv.querySelectorAll('.fill-input')]; let allCorrect = true;
                inputs.forEach(input => { const answerIndex = parseInt(input.dataset.answerIndex, 10); const isInputCorrect = normalizeAnswer(input.value).toLowerCase() === normalizeAnswer(problem.answers[answerIndex]).toLowerCase(); input.classList.add(isInputCorrect ? 'correct' : 'incorrect'); if (!isInputCorrect) allCorrect = false; });
                inputs.forEach(i => i.disabled = true); handleAnswerFeedback(allCorrect, problem.answers.join(', '));
            };
            actionBtn.textContent = '回答'; actionBtn.onclick = handleSubmit; actionBtn.classList.add('visible');
        }
        
        function retryCurrentProblem() {
            feedbackContainer.classList.remove('visible', 'correct', 'incorrect');
            postAnswerButtons.classList.remove('active');
            const problem = wordList[currentIndex];
            if (problem.type === 'select') {
                setupSelect(problem);
            } else if (problem.type === 'enter') {
                setupEnter(problem);
            } else if (problem.type === 'fill') {
                setupFill(problem);
            }
        }
        
        function handleAnswerFeedback(isCorrect, correctAnswerText) {
            const problem = wordList[currentIndex];
            if (problem.type === 'check' || isFinalCheckMode) { isCorrect ? checkOKCount++ : checkReviewCount++; } 
            else { if(isCorrect) correctCount++; }
            if (!isCorrect) {
                if(!reviewList.includes(problem)) reviewList.push(problem);
                if(problem.type !== 'check' && !isFinalCheckMode) mistakeCount++;
            }
            if (problem.type !== 'check' && !isFinalCheckMode) {
                feedbackText.textContent = isCorrect ? '正解！' : `不正解　正しい解答: ${correctAnswerText}`;
                feedbackContainer.classList.add(isCorrect ? 'correct' : 'incorrect', 'visible');
                addToReviewBtn.style.display = 'block'; const isInReviewList = reviewList.includes(problem); addToReviewBtn.disabled = isInReviewList;
                addToReviewBtn.textContent = isInReviewList ? '追加済み' : '復習リストに追加';
                addToReviewBtn.onclick = () => { if (!reviewList.includes(problem)) { reviewList.push(problem); addToReviewBtn.disabled = true; addToReviewBtn.textContent = '追加済み'; } };
                
                actionBtn.classList.remove('visible');
                postAnswerButtons.classList.add('active');
                nextProblemBtn.onclick = moveToNextProblem;
                retryCurrentProblemBtn.onclick = retryCurrentProblem;

            } else { moveToNextProblem(); }
            updateProgress();
        }
        function showIntermediateResults() {
            let percentage, detailsText;
            if (isCheckOnlyMode) {
                const total = checkOKCount + checkReviewCount;
                percentage = total > 0 ? (checkOKCount / total * 100) : 100; detailsText = "理解度";
            } else {
                percentage = currentPassTotalForRate > 0 ? (correctCount / currentPassTotalForRate * 100) : 100;
                detailsText = `${correctCount} / ${currentPassTotalForRate} 問 正解`;
            }
            const visualEl = screens.intermediate.querySelector('.results-visual');
            const percentageEl = document.getElementById('results-percentage');
            document.getElementById('results-details').textContent = detailsText;
            
            const rootStyles = getComputedStyle(document.documentElement);
            const startColorHex = rootStyles.getPropertyValue('--danger-color').trim();
            let endColorHex;
            if (percentage >= 80) endColorHex = rootStyles.getPropertyValue('--success-color').trim();
            else if (percentage >= 50) endColorHex = rootStyles.getPropertyValue('--warning-color').trim();
            else endColorHex = startColorHex;

            triggerMeterAnimation(percentage, visualEl, percentageEl, startColorHex, endColorHex);

            const hasIncorrect = reviewList.length > 0;
            document.getElementById('retry-incorrect-btn').disabled = !hasIncorrect;
            document.getElementById('copy-incorrect-btn').disabled = !hasIncorrect;
            
            const listEl = document.getElementById('incorrect-list');
            listEl.innerHTML = '';
            reviewList.sort((a, b) => b.importance - a.importance).forEach(problem => {
                    const li = document.createElement('li');
                    let correctAnswerText = '';
                    switch (problem.type) { case 'check': correctAnswerText = problem.smallText; break; case 'enter': case 'select': correctAnswerText = problem.correctAnswer; break; case 'fill': correctAnswerText = problem.answers.join(', '); break; }
                    const importanceStars = '★'.repeat(problem.importance) + '☆'.repeat(3 - problem.importance);
                    li.innerHTML = `<div class="incorrect-item-content"><span class="incorrect-item-importance">${importanceStars}</span><span class="incorrect-item-text">${problem.largeText}</span></div><span class="incorrect-item-answer">${correctAnswerText}</span>`;
                    listEl.appendChild(li);
            });
        }
        function moveToNextProblem() { currentIndex++; showNextProblem(); }
        function updateProgress() {
            const total = wordList.length;
            const percentage = total > 0 ? ((currentIndex) / total) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
            progressTextEl.textContent = `問題 ${currentIndex + 1} / ${total}`;
            if (mistakeCount > 0) { mistakeCounter.textContent = `✗ ${mistakeCount}`; mistakeCounter.classList.add('visible'); } else { mistakeCounter.classList.remove('visible'); }
            if (currentIndex < total) { const problem = wordList[currentIndex]; importanceDisplay.textContent = '★'.repeat(problem.importance) + '☆'.repeat(3 - problem.importance); }
        }

        const easeInOutCubic = t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; }
        function rgbToHsv(r, g, b) { r /= 255, g /= 255, b /= 255; let max = Math.max(r, g, b), min = Math.min(r, g, b); let h, s, v = max; let d = max - min; s = max == 0 ? 0 : d / max; if (max == min) { h = 0; } else { switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h /= 6; } return { h: h * 360, s: s, v: v }; }
        function hsvToRgb(h, s, v) { let r, g, b; let i = Math.floor(h / 60) % 6; let f = h / 60 - i; let p = v * (1 - s); let q = v * (1 - f * s); let t = v * (1 - (1 - f) * s); switch (i) { case 0: r = v, g = t, b = p; break; case 1: r = q, g = v, b = p; break; case 2: r = p, g = v, b = t; break; case 3: r = p, g = q, b = v; break; case 4: r = t, g = p, b = v; break; case 5: r = v, g = p, b = q; break; } return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) }; }
        function triggerMeterAnimation(targetPercentage, visualEl, percentageEl, startColorHex, endColorHex) {
            visualEl.style.setProperty('--percentage', 0); percentageEl.textContent = '0%';
            const startRgb = hexToRgb(startColorHex); const endRgb = hexToRgb(endColorHex); if (!startRgb || !endRgb) return;
            const startHsv = rgbToHsv(startRgb.r, startRgb.g, startRgb.b); const endHsv = rgbToHsv(endRgb.r, endRgb.g, endRgb.b);
            const duration = 1200; let startTime = null;
            function animationStep(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsedTime = timestamp - startTime; const progress = Math.min(elapsedTime / duration, 1); const easedProgress = easeInOutCubic(progress);
                const displayPercentage = targetPercentage * easedProgress;
                const h = startHsv.h + easedProgress * (endHsv.h - startHsv.h); const s = startHsv.s + easedProgress * (endHsv.s - startHsv.s); const v = startHsv.v + easedProgress * (endHsv.v - startHsv.v);
                const interpolatedRgb = hsvToRgb(h, s, v); const interpolatedColor = `rgb(${interpolatedRgb.r}, ${interpolatedRgb.g}, ${interpolatedRgb.b})`;
                visualEl.style.setProperty('--percentage', displayPercentage); visualEl.style.setProperty('--progress-color', interpolatedColor);
                percentageEl.textContent = `${Math.floor(displayPercentage)}%`; percentageEl.style.color = interpolatedColor;
                if (progress < 1) requestAnimationFrame(animationStep);
            }
            requestAnimationFrame(animationStep);
        }
        function triggerPerfectAnimation() {
            const endScreen = screens.end; const visualEl = endScreen.querySelector('.results-visual'); const percentageEl = endScreen.querySelector('#end-percentage');
            endScreen.classList.remove('is-animating'); percentageEl.textContent = '0%'; visualEl.style.setProperty('--percentage', 0);
            setTimeout(() => {
                endScreen.classList.add('is-animating');
                const duration = 1200, targetPercentage = 100; let startTime = null;
                function animationStep(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsedTime = timestamp - startTime; const progress = Math.min(elapsedTime / duration, 1); const easedProgress = easeInOutCubic(progress);
                    const displayPercentage = targetPercentage * easedProgress;
                    visualEl.style.setProperty('--percentage', displayPercentage); percentageEl.textContent = `${Math.floor(displayPercentage)}%`;
                    if (progress < 1) requestAnimationFrame(animationStep); else triggerConfetti();
                }
                requestAnimationFrame(animationStep);
            }, 350);
        }
        function triggerConfetti() {
            const ctx = confettiCanvas.getContext('2d'); const W = window.innerWidth, H = window.innerHeight;
            confettiCanvas.width = W; confettiCanvas.height = H;
            const particles = [], particleCount = 150; const colors = ["#34D399", "#FBBF24", "#EF4444", "#60A5FA", "#A78BFA"];
            for (let i = 0; i < particleCount; i++) { particles.push({ x: Math.random() * W, y: Math.random() * H - H, w: Math.random() * 10 + 5, h: Math.random() * 10 + 5, vx: (Math.random() - 0.5) * 10, vy: Math.random() * 5 + 2, angle: Math.random() * 360, color: colors[Math.floor(Math.random() * colors.length)] }); }
            let animationFrameId;
            function draw() {
                ctx.clearRect(0, 0, W, H);
                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i]; ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle * Math.PI / 180);
                    ctx.fillStyle = p.color; ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.restore();
                    p.y += p.vy; p.x += p.vx; p.angle += p.vx / 2;
                    if (p.y > H + 20) { particles.splice(i, 1); i--; }
                }
                if (particles.length > 0) animationFrameId = requestAnimationFrame(draw);
                else { ctx.clearRect(0, 0, W, H); cancelAnimationFrame(animationFrameId); }
            }
            draw();
        }
    </script>
</body>
</html>
